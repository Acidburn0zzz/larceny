<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.0.0" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 2px solid silver;
}
h2 {
  border-bottom: 2px solid silver;
  padding-top: 0.5em;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.2em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock {
  margin-right: 0%;
}
div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
ol.olist2 {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}
</style>
<title>Common Larceny User Manual</title>
</head>
<body>
<div id="header">
<h1>Common Larceny User Manual</h1>
</div>
<h2>Background</h2>
<div class="sectionbody">
<h3>What Is Common Larceny?</h3>
<p>Common Larceny is a variant of Larceny, a simple and efficient run-time system
for Scheme. It is built to run on the ECMA Common Language Infrastructure
(CLI). In Common Larceny, Scheme code is compiled to Common Intermediate
Language, and is then assembled into bytecode for execution by native
just-in-time (JIT) compilers.</p>
<p>When used in conjunction with Microsoft's .NET Framework, which includes an
implementation of the CLI, the Common Language Runtime, Common Larceny provides
an interface to the .NET Framework class library, allowing developers to take
full advantage of dozens of predefined classes designed to facilitate
application development.</p>
<h3>Who Developed Common Larceny?</h3>
<p>Common Larceny was initially developed between 2002 and 2004 by Ryan Culpepper,
Joe Marshall, Dale Vaillancourt, and others under the direction of Will Clinger
and Matthias Felleisen at Northeastern University. Felix Klock, Jesse Tov, and
Chris Burns have contributed to the latest development of Common Larceny.</p>
</div>
<h2>Using Common Larceny</h2>
<div class="sectionbody">
<p>The easiest way to start using Common Larceny is to download a distribution
bundle. Each bundle contains a Common Larceny executable file, and the
libraries required by the executable. If you'd like to build from source, you
can do that, too.</p>
<h3>Requirements</h3>
<p>Currently, this software is distributed for Windows on Intel x86 machines,
Microsoft .NET Framework 2.0.</p>
<p>You can make Common Larceny work on other platforms (e.g. Mac OS X
with the Mono Framework 1.1) but we do not yet provide support for
those systems.</p>
<h4>Common Language Infrastructure</h4>
<p>Before using Common Larceny, you must have some version of the Common Language
Infrastructure on your system. It is recommended that you use the <em>Microsoft
.Net Framework 2.0</em> implementation of the CLI. You only need the .NET
redistributable package, but the .NET SDK contains a much richer set of
utilities and documentation.</p>
<p>Earlier releases of Common Larceny were tested and found to run on the
<em>Microsoft Shared Source CLI (Rotor)</em> and the <em>Mono Runtime</em> but no tests have
been done to determine if the current release runs on these implementations of
the CLI.</p>
<h4>Environment Variables</h4>
<p>Common Larceny requires you to have the environment variable <tt>LARCENY_ROOT</tt>
defined as the root directory of your larceny distribution, e.g. <tt>C:\Larceny\</tt>.</p>
<h3>Distribution Bundle</h3>
<p>Choose one of these distribution bundles:</p>
<ul>
<li>
<p>
Larceny SDK (PLT bundle, DrScheme required) This is the recommended bundle.
   Please see below., see below)
</p>
</li>
<li>
<p>
Larceny SDK (Zip bundle)
</p>
</li>
<li>
<p>
Larceny SDK (MSI) - Microsoft Windows Install file
</p>
</li>
<li>
<p>
Larceny SDK (Gzipped TAR file)
</p>
</li>
</ul>
<p>The <tt>CommonLarceny</tt> executable is a console program. When it is started, it
will print a number of diagnostic lines and then enter a <tt>read-eval-print</tt>
loop.</p>
<p><em>Note:</em> The distributed bundles also include a <tt>Larceny.exe</tt> executable. This is
<em>not</em> the Common Larceny executable. It is used when running the CompileOnLoad
version of Common Larceny (see below).</p>
<h4>DrScheme</h4>
<p>If you choose to download the PLT bundle of Larceny, you will need DrScheme to
unpack it. Also, DrScheme/MzScheme can be used to rebuild Common Larceny from
scratch.</p>
<h3>CompileOnLoad</h3>
<p>Running the executable alone loads Common Larceny as an interpreted Scheme
system. It is also possible to load Common Larceny so that it compiles Scheme
code upon load. This creates slightly longer load times, but can improves
execution times by quite a bit, so some find the CompileOnLoad version of
Common Larceny more useful in certain situations.</p>
<p>To use the CompileOnLoad version of Common Larceny, invoke the runtime with:
<tt>CommonLarceny.exe &#8212; Larceny.fasl</tt>.</p>
<p>Running the command above requires that both <tt>Larceny.fasl</tt> and <tt>Larceny.exe</tt>
exist in the root of your Larceny distribution.</p>
<h3>Building from Source</h3>
<p>If you would like to build Common Larceny from source, download the source
distribution. Once you have downloaded the source distribution, the
instructions below should enable you to build Common Larceny yourself.</p>
<h4>Setup</h4>
<p>To build Larceny from source, you will need a working Scheme system. You can
build Common Larceny with another version of Larceny, or a different Scheme
system like PLT's MzScheme.</p>
<p>You will also need to have a couple of executable programs available in your
path. You may need to edit <tt>src\Rts\DotNet\makefile</tt> to use appropriate programs
on your system.</p>
<ul>
<li>
<p>
You will need a working version of <tt>make</tt> or <tt>nmake</tt>.
</p>
</li>
<li>
<p>
You will need the Intermediate Language Assembler (ILAsm). Usually,
   <tt>ilasm.exe</tt> is located under
   <tt>\Windows\Microsoft.NET\Framework\v?.?.?\ilasm.exe</tt>.
</p>
</li>
<li>
<p>
You will need some version of a C preprocessor. Visual Studio comes with
   <tt>cl.exe</tt>, the Microsoft C/C++ Compiler, which has a command-line
   switch that enables it to preprocess files. Alternatively, you can use
   <tt>cpp</tt>. See options for <tt>larceny-setup</tt> below.
</p>
</li>
</ul>
<p>Once you have ensured the above requirements are met, start your host Scheme
system, and change to the root of the Larceny distribution, if necessary. The
<tt>current-directory</tt> procedure should do the trick. Then, load the
configuration file for Common Larceny: <tt>(load "src/Build/dotnet.sch")</tt></p>
<p>Next, you need to inform the build tool of the specifics of the host
environment. Invoke <tt>larceny-setup</tt> with three or four arguments:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (larceny-setup &lt;host-scheme&gt; &lt;os&gt; &lt;endianness&gt; &lt;codegen-options&gt;)</tt></pre>
</div></div>
<p>where:</p>
<ul>
<li>
<p>
<tt>&lt;host-scheme&gt;</tt> is a string corresponding to your Scheme system; it
     must match one of the subdirectories of Compat, eg <tt>"Petite"</tt>,
    <tt>"MzScheme"</tt>, <tt>"Larceny"</tt>
</p>
</li>
<li>
<p>
<tt>&lt;os&gt;</tt> is a symbol, one of <tt>'win32</tt>, <tt>'unix</tt>, <tt>'macosx</tt>
</p>
</li>
<li>
<p>
<tt>&lt;endianness&gt;</tt> is a symbol, one of <tt>'little</tt>, <tt>'big</tt>
</p>
</li>
<li>
<p>
<tt>&lt;codegen-options&gt;</tt> is an optional combination of:
</p>
<ul>
<li>
<p>
<tt><span>'mono</span></tt> - to build Larceny using the <em>Mono</em> implementation of the
       CLI,
</p>
</li>
<li>
<p>
<tt><span>'rotor</span></tt> - to build Larceny using the <em>Rotor</em> implementation of the
       CLI,
</p>
</li>
<li>
<p>
<tt><span>'debug</span></tt> - to build a debugged version of the runtime-system, and
</p>
</li>
<li>
<p>
<tt><span>'use-cl</span></tt> - to use the <em>Miscrosoft C/C++ Compiler</em>, cl.exe, to
       preprocess certain files needed to build the runtime-system. Without
       this flag, <tt>cpp</tt> will be used.
</p>
</li>
</ul>
</li>
</ul>
<p>For example, to build under MzScheme on a Windows machine, using Microsoft's
C/C++ Compiler, you would use:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (larceny-setup "MzScheme" 'win32 'little 'use-cl)</tt></pre>
</div></div>
<p>After setting up the environment for building Larceny, evaluate the following:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (build-config-files)
&gt; (load-compiler)</tt></pre>
</div></div>
<p>The first procedure builds the config files (<tt>Rts*.cfg</tt>), and the second loads
the Twobit compiler. You can't load the compiler until after you have run
<tt>larceny-setup</tt> and <tt>build-config-files</tt>.</p>
<h4>The .NET Heap</h4>
<p>The next step involves building the .NET heap (it's not as hard as it sounds!).
After loading the compiler in the previous step, simply evaluate:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (make-dotnet-heap)</tt></pre>
</div></div>
<p>This procedure loads the Scheme files needed to build the .NET heap and
compiles and assembles their contained code to MSIL code in three stages. First
it compiles Scheme code to MacScheme code (<tt>.lap</tt> files), then assembles the
MacScheme code into s-expressions representing MSIL code, (<tt>.lop</tt> files), and
finally dumps these s-expressions as raw MSIL code (<tt>.code-il</tt> files).</p>
<p>Evaluating <tt>make-dotnet-heap</tt> produces a file in the root of the Larceny
distribution, <tt>dotnet.heap.exe</tt>. This is the executable file that you will run
to load Common Larceny. In bundled distributions, we rename this to
<tt>CommonLarceny.exe</tt>.</p>
<h4>The Runtime System</h4>
<p>Lastly, you will need to build the runtime system:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (build-runtime-system)</tt></pre>
</div></div>
<p>This procedure will create <tt>Scheme.dll</tt> in the <tt>src\Rts\DotNet</tt> directory. The
<tt>Scheme.dll</tt> library contains the classes that make up the Common Larceny
runtime. Copy <tt>Scheme.dll</tt> into the root directory of the Larceny Distribution.</p>
<p>You should now have a working copy of Common Larceny in your <tt>LARCENY_ROOT</tt>
directory. Run <tt>dotnet.heap.exe</tt> to enter the interactive <tt>read-eval-print</tt>
loop.</p>
<h4>CompileOnLoad</h4>
<p>Optionally, you can build the fast-loading (<tt>.fasl</tt>) file used to invoke the
CompileOnLoad version of Common Larceny (see above). To do this, after building
the heap and the runtime-system, run:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (build-larceny)</tt></pre>
</div></div>
<p>This will create new files in the root of your Larceny distribution, namely
<tt>Larceny.exe</tt> and <tt>Larceny.fasl</tt>. These files are required to run the
CompileOnLoad version of Common Larceny.</p>
<h4>Automating the Build</h4>
<p>One might also create a script to automate the build process. The following
script could be used to achieve such automation, when building on a Windows
machine using MzScheme.</p>
<div class="literalblock">
<div class="content">
<pre><tt>;; boolean boolean boolean boolean -&gt; void
;; builds Common Larceny from source
(define (mz-build build-heap? build-rts? debug? make-fasl?)
  (current-directory (getenv "LARCENY_ROOT"))
  (load "src/Build/dotnet.sch")
  (larceny-setup "MzScheme" 'win32 'little (if debug? 'debug) 'use-cl)
  (build-config-files)
  (load-compiler)
  (if build-heap?
    (let ((heap (make-dotnet-heap)))
      (system "move /Y dotnet.heap.exe CommonLarceny.exe")))
  (if build-rts?
    (let ((rts (build-runtime-system)))
      (system "copy /Y src\\Rts\\DotNet\\Scheme.dll .")))
  (if make-fasl? (build-larceny)))</tt></pre>
</div></div>
<h3>Compiling Code to Run within Common Larceny</h3>
<p>The compiler can also be used to compile code for loading into the
Common Larceny interpreter. This allows you to run programs at compiled
speeds without building the code into the larceny executable.</p>
<p>Load the compiler using the same steps as above:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (load "Util/dotnet.sch")
&gt; (larceny-setup &lt;host-scheme&gt; &lt;os&gt; &lt;endianness&gt; &lt;codegen-options&gt;)
&gt; (load-compiler)</tt></pre>
</div></div>
<p>The compiler is now loaded, and you can use the following procedures:</p>
<div class="literalblock">
<div class="content">
<pre><tt>;; build-application : string (listof string) -&gt; void
;; Given an application name and a list of LOP files, creates
;; an EXE file and a FASL file (each LOP file must have a
;; corresponding MANIFEST file).</tt></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><tt>;; compile-application : string (listof string) -&gt; void
;; Given an application name and a list of scheme source files,
;; creates an EXE file and a FASL file.</tt></pre>
</div></div>
<p>For example:</p>
<div class="literalblock">
<div class="content">
<pre><tt>&gt; (compile-application "EvenAndOdd" (list "even.sch" "odd.sch"))
&gt; (load "EvenAndOdd.fasl")</tt></pre>
</div></div>
<p>or
    &gt; (compile313 "even.sch")
    &gt; (compile313 "odd.sch")
    &gt; (assemble313 "even.lap")
    &gt; (assemble313 "odd.lap")
    &gt; (build-application "EvenAndOdd" (list "even.lop" "odd.lop"))</p>
<p>Note that the first string you supply to build-application or
create-application should have no file extension, and you only load the
resulting FASL file, which must be in the current directory*.</p>
<p>Any Scheme system which can run the compiler can be used to compile the
applications, but of course the resulting FASL files must be loaded
by the Common Larceny interpreter.</p>
</div>
<div id="footer">
<div id="footer-text">
Last updated 07-Nov-2006 14:54:26 EDT
</div>
</div>
</body>
</html>
